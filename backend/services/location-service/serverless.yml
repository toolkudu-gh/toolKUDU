service: toolkudu-location-service

plugins:
  - serverless-plugin-typescript

provider:
  name: aws
  runtime: nodejs20.x
  stage: ${opt:stage, 'dev'}
  region: ${opt:region, 'us-east-1'}
  memorySize: 256
  timeout: 10
  environment:
    STAGE: ${self:provider.stage}
    DB_HOST: ${cf:toolkudu-infrastructure-${self:provider.stage}.RDSEndpoint, env:DB_HOST}
    DB_PORT: ${cf:toolkudu-infrastructure-${self:provider.stage}.RDSPort, '5432'}
    DB_NAME: toolkudu
    DB_USER: ${env:DB_USER, 'toolkudu_admin'}
    DB_PASSWORD: ${env:DB_PASSWORD}
    COGNITO_USER_POOL_ID: ${cf:toolkudu-infrastructure-${self:provider.stage}.UserPoolId, env:COGNITO_USER_POOL_ID}
    COGNITO_CLIENT_ID: ${cf:toolkudu-infrastructure-${self:provider.stage}.UserPoolClientId, env:COGNITO_CLIENT_ID}
  vpc:
    securityGroupIds:
      - ${cf:toolkudu-infrastructure-${self:provider.stage}.LambdaSecurityGroupId, env:LAMBDA_SG_ID}
    subnetIds: ${env:SUBNET_IDS, ''}

functions:
  # Get all trackers for current user
  getTrackers:
    handler: src/handlers/trackers.getTrackers
    events:
      - http:
          path: /trackers
          method: get
          cors: true

  # Get location of a specific tool
  getToolLocation:
    handler: src/handlers/trackers.getToolLocation
    events:
      - http:
          path: /tools/{id}/location
          method: get
          cors: true

  # Add tracker to a tool
  addTracker:
    handler: src/handlers/trackers.addTracker
    events:
      - http:
          path: /tools/{id}/tracker
          method: post
          cors: true

  # Update tracker (location update)
  updateTracker:
    handler: src/handlers/trackers.updateTracker
    events:
      - http:
          path: /tools/{id}/tracker
          method: put
          cors: true

  # Remove tracker from tool
  removeTracker:
    handler: src/handlers/trackers.removeTracker
    events:
      - http:
          path: /tools/{id}/tracker
          method: delete
          cors: true

  # Get location history
  getLocationHistory:
    handler: src/handlers/trackers.getLocationHistory
    events:
      - http:
          path: /tools/{id}/location/history
          method: get
          cors: true

custom:
  serverless-plugin-typescript:
    tsConfigFileLocation: './tsconfig.json'
