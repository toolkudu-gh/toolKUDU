service: toolkudu-sharing-service

plugins:
  - serverless-plugin-typescript

provider:
  name: aws
  runtime: nodejs20.x
  stage: ${opt:stage, 'dev'}
  region: ${opt:region, 'us-east-1'}
  memorySize: 256
  timeout: 10
  environment:
    STAGE: ${self:provider.stage}
    DB_HOST: ${cf:toolkudu-infrastructure-${self:provider.stage}.RDSEndpoint, env:DB_HOST}
    DB_PORT: ${cf:toolkudu-infrastructure-${self:provider.stage}.RDSPort, '5432'}
    DB_NAME: toolkudu
    DB_USER: ${env:DB_USER, 'toolkudu_admin'}
    DB_PASSWORD: ${env:DB_PASSWORD}
    COGNITO_USER_POOL_ID: ${cf:toolkudu-infrastructure-${self:provider.stage}.UserPoolId, env:COGNITO_USER_POOL_ID}
    COGNITO_CLIENT_ID: ${cf:toolkudu-infrastructure-${self:provider.stage}.UserPoolClientId, env:COGNITO_CLIENT_ID}
  vpc:
    securityGroupIds:
      - ${cf:toolkudu-infrastructure-${self:provider.stage}.LambdaSecurityGroupId, env:LAMBDA_SG_ID}
    subnetIds: ${env:SUBNET_IDS, ''}

functions:
  # Toolbox permissions
  getPermissions:
    handler: src/handlers/permissions.getPermissions
    events:
      - http:
          path: /toolboxes/{id}/permissions
          method: get
          cors: true

  updatePermissions:
    handler: src/handlers/permissions.updatePermissions
    events:
      - http:
          path: /toolboxes/{id}/permissions
          method: put
          cors: true

  addPermission:
    handler: src/handlers/permissions.addPermission
    events:
      - http:
          path: /toolboxes/{id}/permissions
          method: post
          cors: true

  removePermission:
    handler: src/handlers/permissions.removePermission
    events:
      - http:
          path: /toolboxes/{id}/permissions/{userId}
          method: delete
          cors: true

  # Lending
  requestLend:
    handler: src/handlers/lending.requestLend
    events:
      - http:
          path: /tools/{id}/lend-request
          method: post
          cors: true

  getIncomingRequests:
    handler: src/handlers/lending.getIncomingRequests
    events:
      - http:
          path: /lending/incoming
          method: get
          cors: true

  getOutgoingRequests:
    handler: src/handlers/lending.getOutgoingRequests
    events:
      - http:
          path: /lending/outgoing
          method: get
          cors: true

  respondToRequest:
    handler: src/handlers/lending.respondToRequest
    events:
      - http:
          path: /lending/{id}/respond
          method: put
          cors: true

  returnTool:
    handler: src/handlers/lending.returnTool
    events:
      - http:
          path: /lending/{id}/return
          method: post
          cors: true

  getLendingHistory:
    handler: src/handlers/lending.getLendingHistory
    events:
      - http:
          path: /lending/history
          method: get
          cors: true

  # Shared tools
  getSharedTools:
    handler: src/handlers/lending.getSharedTools
    events:
      - http:
          path: /tools/shared
          method: get
          cors: true

  getBorrowedTools:
    handler: src/handlers/lending.getBorrowedTools
    events:
      - http:
          path: /tools/borrowed
          method: get
          cors: true

custom:
  serverless-plugin-typescript:
    tsConfigFileLocation: './tsconfig.json'
